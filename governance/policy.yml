# BuildRunner Governance Policy
# This file defines the governance rules and safety controls for the project

version: "1.0.0"
project_id: "buildrunner-saas"
updated_at: "2025-10-30T23:30:00.000Z"
updated_by: "system"

# Protected paths that require special approval
protected_paths:
  - "/buildrunner/specs/plan.json"
  - "/buildrunner/state/runner_state.json"
  - "/supabase/migrations/"
  - "/apps/server/lib/vault.ts"
  - "/.github/workflows/"
  - "/governance/policy.yml"
  - "/package.json"
  - "/package-lock.json"

# Approval requirements
approvals:
  required:
    - role: "admin"
      count: 1
    - role: "tech_lead" 
      count: 1
  protected_paths_override:
    "/buildrunner/specs/plan.json":
      - role: "product_owner"
        count: 1
      - role: "tech_lead"
        count: 1
    "/supabase/migrations/":
      - role: "database_admin"
        count: 1
      - role: "tech_lead"
        count: 1

# Pull Request requirements
pr_requirements:
  microstep_id: true
  microstep_id_pattern: "^p\\d+\\.s\\d+\\.ms\\d+:"
  checklists:
    - "AC checklist present"
    - "Testing completed"
    - "Documentation updated"
  title_pattern: "^(p\\d+\\.s\\d+\\.ms\\d+:|feat|fix|docs|refactor|test):"
  description_min_length: 50

# Secret scanning configuration
secret_scan:
  enabled: true
  block_on_detection: true
  deny_patterns:
    - "(?i)api[_-]?key\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{20,}['\"]?"
    - "(?i)secret[_-]?key\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{20,}['\"]?"
    - "(?i)password\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{8,}['\"]?"
    - "AKIA[0-9A-Z]{16}"  # AWS Access Key
    - "sk-[a-zA-Z0-9]{48}"  # OpenAI API Key
    - "xoxb-[0-9]{11}-[0-9]{11}-[a-zA-Z0-9]{24}"  # Slack Bot Token
    - "ghp_[a-zA-Z0-9]{36}"  # GitHub Personal Access Token
    - "gho_[a-zA-Z0-9]{36}"  # GitHub OAuth Token
    - "postgres://[^\\s]+"  # Database URLs
    - "mongodb://[^\\s]+"
    - "redis://[^\\s]+"
  allowed_patterns:
    - "example_api_key"
    - "your_api_key_here"
    - "placeholder_secret"
    - "\\[REDACTED\\]"
    - "\\*\\*\\*\\*\\*"
  exclude_files:
    - "*.md"
    - "*.example"
    - "*.template"
    - "governance/policy.yml"

# Risk management
risk:
  require_rollback: true
  require_post_check: true
  risk_levels:
    low:
      require_rollback: false
      require_post_check: false
      auto_merge_allowed: true
    medium:
      require_rollback: true
      require_post_check: false
      auto_merge_allowed: false
    high:
      require_rollback: true
      require_post_check: true
      auto_merge_allowed: false
      additional_approvals: 1
    critical:
      require_rollback: true
      require_post_check: true
      auto_merge_allowed: false
      additional_approvals: 2
      require_staging_test: true

# Microstep enforcement
microsteps:
  enforce_in_commits: true
  enforce_in_pr_title: true
  enforce_in_pr_description: true
  require_acceptance_criteria: true
  require_testing_evidence: true
  blocked_statuses:
    - "blocked"
    - "on_hold"
  allowed_transitions:
    "todo": ["doing", "blocked"]
    "doing": ["done", "blocked", "todo"]
    "blocked": ["todo", "doing"]
    "done": []  # Final state

# Branch protection
branches:
  main:
    require_pr: true
    require_reviews: 2
    dismiss_stale_reviews: true
    require_code_owner_reviews: true
    require_status_checks: true
    required_status_checks:
      - "BuildRunner QA"
      - "Governance: Protected Paths"
      - "Governance: Secrets Scan"
      - "Governance: Microstep ID"
    restrict_pushes: true
    allowed_push_users: []
  develop:
    require_pr: true
    require_reviews: 1
    require_status_checks: true
    required_status_checks:
      - "BuildRunner QA"
      - "Governance: Secrets Scan"

# Notifications
notifications:
  slack:
    enabled: false
    webhook_url: ""
    channels:
      governance_alerts: "#governance"
      security_alerts: "#security"
  email:
    enabled: true
    recipients:
      - "admin@dockeryai.com"
  github:
    enabled: true
    create_issues: true
    assign_to_author: true

# Audit settings
audit:
  log_all_actions: true
  retention_days: 365
  export_format: "json"
  include_sensitive_data: false
  
# Emergency procedures
emergency:
  bypass_enabled: true
  bypass_roles:
    - "admin"
    - "emergency_contact"
  bypass_requires_justification: true
  bypass_requires_post_review: true
  bypass_notification_required: true

# Integration settings
integrations:
  github:
    enabled: true
    check_runs: true
    commit_status: true
    pr_comments: true
  supabase:
    enabled: true
    log_to_runner_events: true
  monitoring:
    enabled: true
    alert_on_violations: true

  # External integrations allowed
  integrations_allowed:
    - jira
    - linear
    - vercel
    - render
    - netlify
    - github
    - slack
  external_sync_required: true
  require_preview_for_phase:
    - QA
    - Beta
  max_integrations_per_project: 10

  # Preview environment requirements
  preview_environments:
    required_for_phases:
      - QA
      - Beta
    providers_allowed:
      - vercel
      - render
      - netlify
    auto_deploy_branches:
      - main
      - develop
      - "feature/*"
    retention_days: 7

# Design System Governance
design_system:
  design_parity_required: true
  design_token_threshold: 95
  figma_project_id: "${FIGMA_PROJECT_ID}"
  figma_file_id: "${FIGMA_FILE_ID}"

  visual_regression:
    similarity_threshold: 0.95
    pixel_diff_threshold: 100
    enabled_for_branches:
      - main
      - develop
      - "release/*"

  component_parity:
    enforce_figma_mapping: true
    require_component_docs: true
    allowed_drift_percentage: 5

  token_sync:
    auto_sync_enabled: false
    require_manual_approval: true
    sync_schedule: "0 9 * * 1" # Monday 9 AM

  notifications:
    design_drift_alerts: true
    token_update_notifications: true
    visual_regression_failures: true

# Internationalization & Accessibility Governance
i18n:
  required: true
  default_locale: "en"
  supported_locales:
    - "en"
    - "es"
    - "fr"
    - "de"
  fallback_locale: "en"

  translation_coverage:
    minimum_percentage: 90
    enforce_on_build: true
    exclude_namespaces:
      - "dev"
      - "test"

  ai_translation:
    enabled: true
    auto_translate_threshold: 80
    require_human_verification: true
    max_batch_size: 100

  governance_sync:
    untranslated_warning_threshold: 10
    block_deployment_on_missing: false
    notify_translators: true

accessibility:
  required: true
  wcag_level: "AA"
  wcag_version: "2.1"

  audit_requirements:
    lighthouse_score_min: 90
    axe_violations_max: 0
    color_contrast_min: 4.5
    keyboard_navigation_required: true

  automated_testing:
    enabled: true
    run_on_pr: true
    fail_on_violations: true
    include_pages:
      - "/"
      - "/dashboard"
      - "/projects"
      - "/settings"
      - "/admin"

  manual_testing:
    required_for_major_releases: true
    screen_reader_testing: true
    keyboard_only_testing: true
    high_contrast_testing: true

  reporting:
    store_audit_results: true
    generate_compliance_report: true
    notify_on_regression: true

# Offline & Resilience Governance
offline_resilience:
  offline_mode_enabled: true

  # Sync queue configuration
  sync_queue:
    max_queue_size: 1000
    max_age_hours: 72
    batch_size: 10

  # Exponential backoff configuration
  sync_backoff:
    min_ms: 500
    max_ms: 30000
    factor: 2
    jitter: true
    max_attempts: 5

  # Circuit breaker configuration
  circuit_breaker:
    failure_threshold: 5
    success_threshold: 3
    cooldown_ms: 60000
    half_open_max_calls: 3

  # Conflict resolution strategy
  conflict_resolution:
    strategy: "prompt"           # "prompt", "local_wins", "remote_wins", "auto_merge"
    auto_if_trivial: true
    require_human_verification: true
    max_auto_resolve_fields: 10

  # Degraded mode configuration
  degraded_mode:
    allowed: true
    auto_enable_threshold: 3     # consecutive failures
    features_disabled:
      - "real_time_sync"
      - "external_integrations"
      - "ai_operations"
    features_enabled:
      - "local_editing"
      - "plan_browsing"
      - "export_operations"

  # Health monitoring
  health_monitoring:
    enabled: true
    probe_interval_ms: 30000
    timeout_ms: 10000
    targets:
      - "supabase_db"
      - "supabase_edge"
      - "openai_api"
      - "github_api"
      - "figma_api"
    alert_thresholds:
      consecutive_failures: 3
      latency_ms: 5000
      error_rate_percent: 10

  # Failover configuration
  failover:
    enabled: true
    read_only_fallback: true
    cache_ttl_ms: 300000         # 5 minutes
    fallback_endpoints:
      supabase_db: "read_replica_url"
      static_assets: "cdn_fallback_url"

  # Queue visibility and alerts
  queue_management:
    dashboard_enabled: true
    real_time_updates: true
    alert_on_backlog_size: 100
    alert_on_age_hours: 24
    alert_channels:
      - "slack"
      - "email"
      - "webhook"

  # Chaos engineering
  chaos_testing:
    enabled: true
    environments: ["development", "staging"]
    max_failure_duration_ms: 60000
    failure_types:
      - "network_latency"
      - "network_drop"
      - "server_error"
      - "timeout"
    schedule: "nightly"
